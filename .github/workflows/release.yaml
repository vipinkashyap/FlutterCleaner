name: Build macOS App and Export ZIP

on:
  push:
    tags:
      - "v*.*.*"
permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode Version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"

      - name: Build Release App
        run: |
          xcodebuild -project FlutterCleaner.xcodeproj \
            -scheme FlutterCleaner \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Compress app into ZIP
        run: |
          cd build/Build/Products/Release
          cat > INSTALL.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>FlutterCleaner Installation</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 2rem; line-height: 1.6; }
                  h1 { color: #007AFF; }
                  code { background: #f2f2f2; padding: 4px 6px; border-radius: 4px; }
              </style>
          </head>
          <body>
              <h1>ğŸ§¹ FlutterCleaner Installation</h1>
              <p>Thank you for downloading <strong>FlutterCleaner</strong>!</p>
              <h2>ğŸ“¥ Install</h2>
              <p>1. Drag <strong>FlutterCleaner.app</strong> into your <strong>/Applications</strong> folder.</p>
              <h2>âš ï¸ macOS â€œApp is Damagedâ€ Warning</h2>
              <p>Because FlutterCleaner is unsigned (developer tool), macOS may show:</p>
              <blockquote>â€œFlutterCleaner.app is damaged and canâ€™t be opened.â€</blockquote>
              <p>This is normal. Open the app once and follow the builtâ€‘in popup to fix quarantine.</p>
              <h3>Or run manually:</h3>
              <code>sudo xattr -rd com.apple.quarantine /Applications/FlutterCleaner.app</code>
              <h2>ğŸ‰ Done!</h2>
              <p>You can now run FlutterCleaner normally.</p>
          </body>
          </html>
          EOF
          zip -r FlutterCleaner.zip FlutterCleaner.app INSTALL.html

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: build/Build/Products/Release/FlutterCleaner.zip
